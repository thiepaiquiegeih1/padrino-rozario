# Обзор кодовой базы проекта Розарио.Цветы

## Архитектура и технологический стек

### Основной фреймворк
- **Padrino Framework 0.11.1** - Ruby веб-фреймворк, построенный на Sinatra
- **ActiveRecord 3.x** - ORM для работы с базой данных
- **Ruby** - основной язык программирования

### База данных
- **MySQL 2** (`mysql2` gem ~> 0.3.14)
- База данных: `admin_rozario`
- Соединение через ActiveRecord
- Схема версии 88 (последняя миграция)

### Кеширование и фоновые задачи
- **Redis** - кеширование и сессии
- **Sidekiq 4.2.10** - фоновые задачи
- **Rack::Cache** с Redis backend
- **ConnectionPool** для управления соединениями Redis

### Веб-серверы
- **Phusion Passenger** (основной)
- **Puma** (альтернативный)
- **Thin** (для разработки)

### Вспомогательные технологии
- **Haml** - шаблонизатор (258 файлов, 42% от всех файлов)
- **ERB** - альтернативный шаблонизатор (54 файла)
- **Carrierwave** - загрузка файлов
- **RMagick/Mini Magick** - обработка изображений
- **Will Paginate** - пагинация
- **reCAPTCHA** - защита от ботов
- **Nokogiri** - парсинг XML/HTML
- **JSON** - сериализация данных

## Структура проекта

### Основные приложения
1. **Rozario::App** (`/app/app.rb`) - основное приложение, монтируется в корень `/`
2. **Rozario::Admin** (`/admin/app.rb`) - административная панель, монтируется в `/admin`

### Директории проекта

```
/app/
├── app.rb              # Основное приложение
├── controllers/        # Контроллеры основного приложения
├── models/            # Модели ActiveRecord
├── views/             # Шаблоны (HAML/ERB)
├── helpers/           # Хелперы
└── mailers/           # Почтовые классы

/admin/
├── app.rb             # Административное приложение
└── controllers/       # Контроллеры админки

/config/
├── boot.rb            # Инициализация приложения
├── apps.rb            # Монтирование приложений
├── database.rb        # Настройки БД
├── puma.rb            # Настройки Puma
└── initializers/      # Инициализаторы

/db/
├── schema.rb          # Схема БД
├── seeds.rb           # Семена
└── migrate/           # Миграции

/lib/                  # Библиотеки
/tasks/                # Rake задачи
/workers/              # Sidekiq воркеры
/test/                 # Тесты
```

## Основные модели

### E-commerce модели
- **Product** - товары (цветы, букеты)
- **Category** - категории товаров
- **Order** - заказы
- **OrderProduct** - позиции заказов
- **ProductComplect** - комплектации товаров
- **Cart** - корзина покупок

### Контентные модели
- **Article** - статьи
- **News** - новости
- **Comment** - отзывы
- **Page** - статические страницы
- **Smile** - отзывы с эмоциями

### SEO и маркетинг
- **Seo** - SEO метаданные
- **SeoGeneral** - общие SEO настройки
- **Subdomain** - поддомены
- **Mailing** - рассылки

### Система и настройки
- **Account** - аккаунты администраторов
- **GeneralConfig** - общие настройки
- **PaymentMethod** - методы оплаты
- **Tax** - налоги

## Ключевые контроллеры

### Основное приложение (`/app/controllers/`)
- **api.rb** - API для интеграции с 1С (58KB кода)
- **cart.rb** - корзина и оформление заказов
- **product.rb** - отображение товаров
- **category.rb** - каталог товаров
- **comment.rb** - система отзывов
- **payment.rb** - обработка платежей
- **sessions.rb** - авторизация пользователей

### Админка (`/admin/controllers/`)
- Управление всеми сущностями системы
- CRUD операции для товаров, заказов, контента
- Настройки системы

## Особенности архитектуры

### Redis Integration
- Кеширование страниц по ключам типа `subdomain:page_type:id`
- Управление сессиями
- Connection pooling для производительности
- Автоматическое переподключение после форка процессов

### Мультисайтовость
- Система поддоменов (`Subdomain` модель)
- Разные настройки для разных городов/регионов
- Динамическое определение текущего поддомена

### SEO оптимизация
- Продвинутая система SEO метатегов
- Schema.org разметка
- Канонические URL
- Поддержка OpenGraph и Twitter Cards

### API интеграция
- Мощный API для синхронизации с 1С
- Обработка изображений товаров
- Автоматическое создание товаров и категорий

## Важные ограничения проекта

⚠️ **КРИТИЧЕСКИ ВАЖНО:**

1. **НЕ МЕНЯТЬ СТРУКТУРУ БД** без явного разрешения
2. **НЕ СОЗДАВАТЬ МИГРАЦИИ** без подтверждения
3. **Отсутствуют ресурсы:**
   - JS скрипты (хранятся отдельно)
   - CSS файлы (хранятся отдельно) 
   - Шрифты (хранятся отдельно)
   - Изображения (хранятся отдельно)

4. **Конфигурация окружения:**
   - Использует переменные среды для паролей БД и Redis
   - Разные настройки для development/production/staging
   - Passenger как основной веб-сервер

## Команды для работы

```bash
# Запуск сервера разработки
./start.passenger.sh

# Установка зависимостей
./bundler.sh

# Миграции (ОСТОРОЖНО!)
./migration.sh

# Очистка HTML комментариев
./cleanup_html_comments.rb

# Sidekiq (фоновые задачи)
# Доступен веб-интерфейс на /admin/sidekiq
```

## Тестирование

- Тесты находятся в `/test/`
- Используется Minitest
- Есть специальные тесты для UI (`test/README_UI_TESTS.md`)
- Множество специализированных скриптов для тестирования конкретной функциональности

Этот проект представляет собой зрелую e-commerce платформу для продажи цветов с богатой функциональностью, включая мультисайтовость, продвинутое SEO, интеграцию с 1С и современные технологии кеширования.
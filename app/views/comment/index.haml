- # encoding: utf-8
- @title = "–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ | –î–æ—Å—Ç–∞–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤ ‚Ññ1 " + @subdomain.city

/ see also
/ https://github.com/ambethia/recaptcha
/ https://github.com/ambethia/recaptcha/blob/master/demo/sinatra/server.rb

%div.hidden-xs.hidden-sm{style:"height: 42px"}
#comment-form
  %h1{:style => "font-size: 20px;"}=@seo[:h1].html_safe
  %h2 –û—Å—Ç–∞–≤—å—Ç–µ –í–∞—à –æ—Ç–∑—ã–≤
  
  - user_authenticated = current_account || session[:user_id]
  - if user_authenticated
    - auth_user = current_account || (session[:user_id] ? UserAccount.find(session[:user_id]) : nil)
    -form_tag url(:feedback, :submit), :method => 'post', :class => 'form comment', :id => 'FORM' do |f|
      = flash_tag(:notice)
      = flash_tag(:error)
      %input{type: "hidden", name: "g-recaptcha-response"}
      -# –ü–æ–ª—è –∏–º–µ–Ω–∏ –∏ email —É–±—Ä–∞–Ω—ã, –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      .row.a2
        .col-md-12
          - field_set_tag do
            = label_tag :order_eight_digit_id, :caption => '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ *'
            - if @user_orders && !@user_orders.empty?
              %select{:name => 'order_eight_digit_id', :id => 'FORM_ORDER_ID', :required => true}
                %option{:value => '', :disabled => true, :selected => true} -- –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ --
                - @user_orders.each do |order|
                  %option{:value => order.first, :selected => (params[:order_eight_digit_id] == order.first)} –ó–∞–∫–∞–∑ ‚Ññ #{order.first} –æ—Ç #{order.last.strftime('%d.%m.%Y')}
            - else
              = text_field_tag :order_eight_digit_id, :value => params[:order_eight_digit_id], :placeholder => '–ù–∞–ø—Ä–∏–º–µ—Ä: 12345678', :pattern => '[0-9]{8}', :title => '8-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', :id => 'FORM_ORDER_ID', :required => true
            %small.help-block 
              - if @user_orders && !@user_orders.empty?
                –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –¥–ª—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞
              - else
                –í–≤–µ–¥–∏—Ç–µ 8-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞
      .row.a3
        .col-md-12
          = partial("partials/snd-rating", :engine => :erb)
      .row.b
        .col-md-12
          - field_set_tag do
            = label_tag :msg, :caption => '–í–∞—à –æ—Ç–∑—ã–≤'
            = text_area_tag :msg, :value => params[:msg], :required => '', :id => 'FORM_MSG'
      .row.c
        .col-md-12
          - field_set_tag(:class => 'buttons') do
            = submit_tag '–û—Ç–ø—Ä–∞–≤–∏—Ç—å', :class => 'btn', :id => "SUBMIT"
  
  - else
    .auth-required{style: "background: #f5f5f5; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: center;"}
      %p{style: "font-size: 16px; margin-bottom: 15px;"}
        = link_to '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å', url(:sessions, :new), :style => 'color: #337ab7; text-decoration: none;'
        –∏–ª–∏ 
        = link_to '–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å', url(:user_accounts, :new), :style => 'color: #337ab7; text-decoration: none;'
        , —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à –æ—Ç–∑—ã–≤!

#comments
  = partial 'comment/comment', :collection => @comments
  
-# –õ–æ–∞–¥–µ—Ä –¥–ª—è lazy loading
- if defined?(@has_more) && @has_more
  #comments-loader{style: "text-align: center; padding: 20px; display: none;"}
    .loader-spinner{style: "display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;"}
    %p{style: "margin-top: 10px; color: #666;"} –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...

-# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–∫–æ–Ω—á–∞–Ω–∏—è
- if defined?(@has_more) && !@has_more && defined?(@page) && @page > 1
  #comments-end{style: "text-align: center; padding: 20px; color: #888;"}
    %p –í—Å–µ –æ—Ç–∑—ã–≤—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã

-# Schema.org Reviews markup for SEO
= generate_reviews_schema(@comments)

:css
  @media only screen and (max-width: 992px) {
    .delivery-lg {
      display: none !important;
      #comment-form > h2 {margin: 24px 0 !important;}
    }
  }
  span.star-rating { padding-top: 12px; }
  
  @media screen and (width <= 1024px) {
    #sidebarrr {display: none;}
  }
  
  /* CSS –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loader-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 2s linear infinite;
  }
  
  .comments-loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  .comment-item {
    transition: opacity 0.3s ease-in-out;
  }
  
  .comment-item.fade-in {
    animation: fadeIn 0.5s ease-in-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

:javascript
  $('.feedback').css('display','none');
  
  // reCAPTCHA
  if (typeof grecaptcha !== 'undefined') {
    grecaptcha.ready(function() {
      grecaptcha.execute('6LdUkAIqAAAAAPmW_r2jFaMvjMa8o-kelRM_nKKi', {action: 'submit'}).then(function(token) {
        document.getElementsByName('g-recaptcha-response')[0].value = token;
      });
    });
  }
  
  // Lazy Loading –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
  (function() {
    let currentPage = #{defined?(@page) ? @page.to_i : 1};
    let hasMore = #{defined?(@has_more) ? @has_more.to_json : 'false'};
    let isLoading = false;
    const commentsContainer = document.getElementById('comments');
    const loader = document.getElementById('comments-loader');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã
    if (!commentsContainer || !hasMore) {
      console.log('Lazy loading –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–ª–∏ –Ω–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤');
      return;
    }
    
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è lazy loading: —Å—Ç—Ä–∞–Ω–∏—Ü–∞', currentPage, '–µ—Å—Ç—å –µ—â—ë:', hasMore);
    
    function loadMoreComments() {
      if (isLoading || !hasMore) {
        console.log('–ü—Ä–æ–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏: isLoading=' + isLoading + ', hasMore=' + hasMore);
        return;
      }
      
      isLoading = true;
      currentPage++;
      
      console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã ' + currentPage);
      
      // –ü—Ä–æ–±—É–µ–º fetch API –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥, –ø–æ—Ç–æ–º XMLHttpRequest
      if (typeof fetch !== 'undefined') {
        loadWithFetch();
      } else {
        loadWithXHR();
      }
    }
    
    function loadWithFetch() {
      console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º Fetch API');
      
      const url = '/comment/load_more?page=' + currentPage + '&t=' + Date.now();
      
      fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json, text/javascript, */*; q=0.01',
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        },
        credentials: 'same-origin'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        handleSuccessResponse(data);
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ Fetch API:', error);
        console.log('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ XMLHttpRequest');
        loadWithXHR();
      });
    }
    
    function loadWithXHR() {
      console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º XMLHttpRequest');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
      if (loader) {
        loader.style.display = 'block';
      }
      
      console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É', currentPage);
      
      // –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—ã–π XMLHttpRequest –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ includes.js
      const NativeXHR = window.XMLHttpRequest;
      const xhr = new NativeXHR();
      xhr.open('GET', '/comment/load_more?page=' + currentPage + '&t=' + Date.now(), true);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
      xhr.setRequestHeader('Cache-Control', 'no-cache');
      xhr.setRequestHeader('Pragma', 'no-cache');
      
      // –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
      xhr.timeout = 15000; // 15 —Å–µ–∫—É–Ω–¥
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              handleSuccessResponse(response);
            } catch (e) {
              handleErrorResponse('JSON parsing error: ' + e.message + '. Server response: ' + xhr.responseText);
            }
          } else {
            let errorMsg = 'HTTP Error ' + xhr.status;
            if (xhr.status === 404) {
              errorMsg += ': Endpoint not found. Check /comment/load_more route.';
            } else if (xhr.status === 0) {
              errorMsg += ': Network error or CORS issue.';
            } else {
              errorMsg += ': ' + xhr.statusText;
            }
            handleErrorResponse(errorMsg);
          }
        }
      };
      
      xhr.onerror = function() {
        handleErrorResponse('XMLHttpRequest network error');
      };
      
      xhr.ontimeout = function() {
        handleErrorResponse('XMLHttpRequest timeout after 15 seconds');
      };
      
      xhr.send();
    }
    
    function handleSuccessResponse(response) {
      // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
      if (loader) {
        loader.style.display = 'none';
      }
      
      if (response.html && response.html.trim()) {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = response.html;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
        Array.from(tempDiv.children).forEach((child, index) => {
          child.classList.add('comment-item', 'fade-in');
          setTimeout(() => {
            commentsContainer.appendChild(child);
          }, index * 100); // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
        });
        
        console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Ç–∑—ã–≤–æ–≤:', response.html.split('<article').length - 1);
      } else {
        console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞');
        hasMore = false;
      }
      
      hasMore = response.has_more;
      
      if (!hasMore) {
        console.log('‚úÖ –í—Å–µ –æ—Ç–∑—ã–≤—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        showEndMessage();
      }
      
      isLoading = false;
    }
    
    function handleErrorResponse(error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
      if (loader) {
        loader.style.display = 'none';
      }
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º lazy loading –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
      hasMore = false;
      isLoading = false;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'text-align: center; padding: 20px; color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin: 10px 0;';
      errorDiv.innerHTML = '<p>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤</p>';
      commentsContainer.parentNode.appendChild(errorDiv);
    }
    
    function showEndMessage() {
      const endMessage = document.getElementById('comments-end');
      if (endMessage) {
        endMessage.style.display = 'block';
      } else {
        const endDiv = document.createElement('div');
        endDiv.id = 'comments-end';
        endDiv.style.cssText = 'text-align: center; padding: 20px; color: #888;';
        endDiv.innerHTML = '<p>üéâ –í—Å–µ –æ—Ç–∑—ã–≤—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>';
        commentsContainer.parentNode.appendChild(endDiv);
      }
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    function handleScroll() {
      if (isLoading || !hasMore) return;
      
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–ª–æ—Å—å 200px –¥–æ –∫–æ–Ω—Ü–∞
      if (scrollTop + windowHeight >= documentHeight - 200) {
        console.log('–¢—Ä–∏–≥–≥–µ—Ä lazy loading –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ');
        loadMoreComments();
      }
    }
    
    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    let scrollTimeout;
    window.addEventListener('scroll', function() {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = setTimeout(handleScroll, 100); // –î–µ–±–∞—É–Ω—Å 100–º—Å
    });
    
    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    window.loadMoreCommentsManual = loadMoreComments;
  })();

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –≤ localStorage –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
  if (document.getElementById('FORM')) {
    document.getElementById('FORM').addEventListener('submit', function() {
      var msg = document.getElementById('FORM_MSG').value;
      localStorage.setItem('msg', msg);
      var orderId = document.getElementById('FORM_ORDER_ID').value;
      localStorage.setItem('order_eight_digit_id', orderId);
    });
  }

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('FORM_MSG') && localStorage.getItem('msg')) {
      document.getElementById('FORM_MSG').value = localStorage.getItem('msg');
    }
    if (document.getElementById('FORM_ORDER_ID') && localStorage.getItem('order_eight_digit_id')) {
      document.getElementById('FORM_ORDER_ID').value = localStorage.getItem('order_eight_digit_id');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (localStorage.getItem('user_just_authenticated') === 'true') {
      localStorage.removeItem('user_just_authenticated');
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞
      window.location.reload(true); // true = –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
    }
  });
